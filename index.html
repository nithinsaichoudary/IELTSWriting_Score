<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing Correction Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }

        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .task-type {
            margin-bottom: 15px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .button-disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .button-disabled:hover {
            background-color: #95a5a6;
        }

        .result-container {
            margin-top: 30px;
            display: none;
        }

        .score-container {
            display: flex;
            justify-content: space-between;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .score-box {
            text-align: center;
            flex: 1;
            padding: 10px;
        }

        .score-box h3 {
            margin: 0;
            font-size: 18px;
            color: #555;
        }

        .score-box .score {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .overall-score {
            background-color: #3498db;
            color: white;
            border-radius: 5px;
        }

        .overall-score h3,
        .overall-score .score {
            color: white;
        }

        .feedback-section {
            margin-top: 20px;
        }

        .error {
            background-color: #ffecec;
            border-left: 3px solid #ff6b6b;
            padding: 10px;
            margin-bottom: 10px;
        }

        .correction {
            background-color: #e7f7e7;
            border-left: 3px solid #6bcb77;
            padding: 10px;
            margin-bottom: 10px;
        }

        .highlighted-text {
            margin-top: 30px;
            line-height: 1.8;
        }

        .grammar-error {
            background-color: #ffcccc;
            padding: 2px;
            border-radius: 3px;
        }

        .vocabulary-error {
            background-color: #ffffcc;
            padding: 2px;
            border-radius: 3px;
        }

        .coherence-error {
            background-color: #cce0ff;
            padding: 2px;
            border-radius: 3px;
        }

        .legend {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .legend-item {
            margin-left: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
        }

        .word-count {
            text-align: right;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .api-key-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .api-key-input {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .analysis-mode {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
        }

        .analysis-mode label {
            margin-right: 20px;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .benchmark-container {
            margin-top: 20px;
            display: none;
        }

        .benchmark-samples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .benchmark-sample {
            background-color: #eee;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .benchmark-sample:hover {
            background-color: #ddd;
        }

        .benchmark-sample.active {
            background-color: #3498db;
            color: white;
        }

        .advice-container {
            margin-top: 20px;
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>IELTS Writing Correction Tool</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('writing')">Writing Correction</div>
            <div class="tab" onclick="switchTab('info')">IELTS Info</div>
            <div class="tab" onclick="switchTab('benchmark')">Benchmark Samples</div>
            <div class="tab" onclick="switchTab('settings')">API Settings</div>
        </div>

        <div id="writing-tab">
            <div class="task-type">
                <label><input type="radio" name="task" value="task1" checked> Task 1 (Graph/Chart Description)</label>
                <label style="margin-left: 20px;"><input type="radio" name="task" value="task2"> Task 2 (Essay)</label>
            </div>

            <div class="analysis-mode">
                <label><input type="radio" name="mode" value="basic" checked> Basic Analysis (No API needed)</label>
                <label><input type="radio" name="mode" value="advanced"> Advanced Analysis with AI (API key
                    needed)</label>
            </div>

            <textarea id="essay-input" placeholder="Paste your IELTS writing response here..."></textarea>
            <div class="word-count">Word count: <span id="word-count">0</span></div>

            <button id="analyze-button" onclick="analyzeEssay()">Analyze Writing</button>
            <div class="loader" id="analysis-loader"></div>

            <div id="result-container" class="result-container">
                <h2>Analysis Results</h2>

                <div class="score-container">
                    <div class="score-box">
                        <h3>Task Achievement</h3>
                        <div class="score" id="task-score">0.0</div>
                    </div>
                    <div class="score-box">
                        <h3>Coherence & Cohesion</h3>
                        <div class="score" id="coherence-score">0.0</div>
                    </div>
                    <div class="score-box">
                        <h3>Lexical Resource</h3>
                        <div class="score" id="lexical-score">0.0</div>
                    </div>
                    <div class="score-box">
                        <h3>Grammar</h3>
                        <div class="score" id="grammar-score">0.0</div>
                    </div>
                    <div class="score-box overall-score">
                        <h3>Overall</h3>
                        <div class="score" id="overall-score">0.0</div>
                    </div>
                </div>

                <div class="feedback-section">
                    <h3>Overall Feedback</h3>
                    <p id="overall-feedback"></p>

                    <div id="ai-feedback-container" style="display: none;">
                        <h3>AI-Powered Detailed Feedback</h3>
                        <div id="ai-feedback" class="advice-container"></div>
                    </div>

                    <h3>Detailed Corrections</h3>
                    <div id="corrections-container"></div>

                    <h3>Your Text with Highlights</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ffcccc;"></span> Grammar
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ffffcc;"></span> Vocabulary
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #cce0ff;"></span> Coherence
                        </div>
                    </div>
                    <div class="highlighted-text" id="highlighted-text"></div>
                </div>
            </div>
        </div>

        <div id="info-tab" style="display: none;">
            <h2>IELTS Writing Assessment Criteria</h2>

            <h3>Task 1</h3>
            <ul>
                <li><strong>Task Achievement:</strong> How well you address all parts of the task with relevant
                    information.</li>
                <li><strong>Coherence and Cohesion:</strong> How well your answer is organized with proper paragraphing
                    and linking.</li>
                <li><strong>Lexical Resource:</strong> Your range and accuracy of vocabulary.</li>
                <li><strong>Grammatical Range and Accuracy:</strong> Your range and accuracy of grammar.</li>
            </ul>

            <h3>Task 2</h3>
            <ul>
                <li><strong>Task Response:</strong> How well you address all parts of the task with a position supported
                    by relevant ideas.</li>
                <li><strong>Coherence and Cohesion:</strong> How well your essay is organized with proper paragraphing
                    and linking.</li>
                <li><strong>Lexical Resource:</strong> Your range and accuracy of vocabulary.</li>
                <li><strong>Grammatical Range and Accuracy:</strong> Your range and accuracy of grammar.</li>
            </ul>

            <h3>Band Score Requirements</h3>
            <ul>
                <li><strong>Band 9 (Expert):</strong> Complete mastery of English with accurate, appropriate, and fluent
                    usage.</li>
                <li><strong>Band 8 (Very Good):</strong> Very good command with only occasional inaccuracies.</li>
                <li><strong>Band 7 (Good):</strong> Good command with some inaccuracies and misunderstandings.</li>
                <li><strong>Band 6 (Competent):</strong> Generally effective command with some errors and
                    misunderstandings.</li>
                <li><strong>Band 5 (Modest):</strong> Partial command with many errors and misunderstandings.</li>
                <li><strong>Band 4 (Limited):</strong> Limited command with frequent problems in accuracy and
                    understanding.</li>
            </ul>

            <h3>Word Count Requirements</h3>
            <ul>
                <li><strong>Task 1:</strong> Minimum 150 words</li>
                <li><strong>Task 2:</strong> Minimum 250 words</li>
            </ul>

            <div class="advice-container">
                <h3>Tips for Improving Your IELTS Writing Score</h3>
                <ol>
                    <li><strong>Structure your essay clearly:</strong> Include an introduction, body paragraphs, and a
                        conclusion.</li>
                    <li><strong>Address all parts of the prompt:</strong> Make sure you cover everything the question
                        asks.</li>
                    <li><strong>Use a variety of sentence structures:</strong> Mix simple, compound, and complex
                        sentences.</li>
                    <li><strong>Use high-level vocabulary:</strong> Include topic-specific terms and academic
                        expressions.</li>
                    <li><strong>Use cohesive devices appropriately:</strong> Linking words help your ideas flow
                        smoothly.</li>
                    <li><strong>Support your ideas:</strong> Include examples, explanations, and evidence.</li>
                    <li><strong>Practice timed writing:</strong> Build the skill of completing tasks within the time
                        limit.</li>
                    <li><strong>Review your work:</strong> Save time to check for errors before submitting.</li>
                </ol>
            </div>
        </div>

        <div id="benchmark-tab" style="display: none;">
            <h2>Benchmark Essays</h2>
            <p>These are sample essays with their official IELTS band scores. Use them to understand the scoring
                criteria and compare your work.</p>

            <h3>Task 2 Samples</h3>
            <div class="benchmark-samples">
                <div class="benchmark-sample" onclick="loadBenchmarkSample('band9')">Band 9 Sample</div>
                <div class="benchmark-sample" onclick="loadBenchmarkSample('band8')">Band 8 Sample</div>
                <div class="benchmark-sample" onclick="loadBenchmarkSample('band7')">Band 7 Sample</div>
                <div class="benchmark-sample" onclick="loadBenchmarkSample('band6')">Band 6 Sample</div>
                <div class="benchmark-sample" onclick="loadBenchmarkSample('band5')">Band 5 Sample</div>
            </div>

            <textarea id="benchmark-text" style="height: 300px;" readonly></textarea>
            <div id="benchmark-analysis" class="advice-container" style="display: none;"></div>
        </div>

        <div id="settings-tab" style="display: none;">
            <h2>API Settings</h2>
            <p>Enter your API key to enable advanced AI-powered analysis. Your API key is stored locally in your browser
                and is never sent to our servers.</p>

            <div class="api-key-container">
                <input type="text" id="api-key-input" class="api-key-input" placeholder="Enter your Gemini API Key">
                <button onclick="saveApiKey()">Save API Key</button>
            </div>

            <div class="advice-container">
                <h3>How to Get a Gemini API Key</h3>
                <ol>
                    <li>Go to <a href="https://ai.google.dev/" target="_blank">Google AI Studio</a></li>
                    <li>Sign in with your Google account</li>
                    <li>Navigate to the API keys section</li>
                    <li>Create a new API key</li>
                    <li>Copy and paste the key into the field above</li>
                </ol>
                <p><strong>Note:</strong> The Gemini API may have usage limits and charges. Please review Google's
                    pricing details before use.</p>
            </div>
        </div>
    </div>

    <script>
        // Store the API key in localStorage
        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                alert('API key saved successfully!');
            } else {
                alert('Please enter a valid API key.');
            }
        }

        // Load API key from localStorage when page loads
        document.addEventListener('DOMContentLoaded', function () {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
        });

        // Function to switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('writing-tab').style.display = 'none';
            document.getElementById('info-tab').style.display = 'none';
            document.getElementById('benchmark-tab').style.display = 'none';
            document.getElementById('settings-tab').style.display = 'none';

            document.getElementById(tabName + '-tab').style.display = 'block';
            document.querySelector(`.tab:nth-child(${tabName === 'writing' ? 1 : tabName === 'info' ? 2 : tabName === 'benchmark' ? 3 : 4})`).classList.add('active');
        }

        // Word count functionality
        document.getElementById('essay-input').addEventListener('input', function () {
            const text = this.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            document.getElementById('word-count').textContent = wordCount;
        });

        // Benchmark essay samples
        const benchmarkSamples = {
            band9: `Some people believe that unpaid community service should be a compulsory part of high school education. To what extent do you agree or disagree?

In contemporary society, there is an ongoing debate about integrating mandatory community service into high school curricula. While critics argue that students' time would be better spent on academic pursuits, I firmly believe that compulsory community service provides invaluable benefits that extend well beyond the classroom.

Fundamentally, community service cultivates empathy and social responsibility in adolescents during a crucial developmental period. When students engage with diverse community members—whether assisting at senior centers, participating in environmental restoration projects, or helping at homeless shelters—they develop firsthand understanding of societal challenges. This experiential learning cannot be replicated through textbooks alone. Research from the Harvard Graduate School of Education demonstrates that students who participate in community service develop stronger prosocial behaviors and emotional intelligence, attributes increasingly valued in both personal and professional spheres.

Furthermore, mandatory service programs significantly enhance students' practical skills and career readiness. Through these experiences, adolescents develop project management abilities, interpersonal communication, problem-solving capabilities, and leadership qualities in authentic contexts. For instance, a student organizing a community food drive must coordinate logistics, communicate with stakeholders, manage resources, and adapt to unexpected challenges—all transferable skills highly sought after by universities and employers alike. Moreover, community engagement often provides valuable networking opportunities and helps students identify potential career pathways they might otherwise never have considered.

Critics may contend that making community service compulsory undermines its altruistic value and overburdens already-busy students. However, this perspective overlooks the reality that many adolescents would never voluntarily step outside their comfort zones without initial requirement. Properly implemented programs can start with mandatory participation but ultimately nurture genuine interest in civic engagement. Additionally, well-designed service programs can be integrated with academic learning, reinforcing classroom concepts through practical application rather than competing with educational priorities.

In conclusion, I strongly agree that unpaid community service should be a mandatory component of high school education. The benefits—including enhanced empathy, practical skill development, and community building—far outweigh potential drawbacks. Educational institutions should focus not on whether to implement such programs, but rather on how to structure them effectively to maximize their positive impact on both students and communities.`,

            band8: `Nowadays an increasing number of people are becoming concerned about their health and the quality of their diet. There are two diametrically opposed opinions on the matter. Some people believe that each and every individual is responsible for their own health while others state that it is the government that must ensure that the citizens have healthy eating habits.

Personally, I believe that people bear full responsibility for their diets for a number of reasons. First, nowadays there is a vast variety of products that everyone can choose from, ensuring a balanced diet consisting of different types of products with sufficient vitamins, proteins, carbohydrates and fats. Everyone can balance their diets according to these factors and also based on their taste preferences. For example vegetarians will prefer beans rich in protein while omnivorous eaters might opt for meat instead. Secondly, while governments cannot considerably vary in their healthy eating programs usually adhering to 'one size fits all' approach, individuals know exactly what they need in order to keep fit and healthy both generally speaking and in terms of food. We take tailored approach as we know exactly what we need to succeed in life, be strong and healthy.

However, others argue that the government is fully responsible for the kind of food its population consume because they make decisions regarding the quality of food their country produce and import as well as prices. For instance, in many developing countries people rarely have access to high quality food, thus being forced to choose something cheap like fast food. Moreover, the government can introduce legislation as regards to what kind of food can be promoted, seen for example in many European countries where the advertising of fast food, alcohol and cigarettes is prohibited. These measure, it is argued, can affect the way we eat and control the diets of the whole population.

In conclusion, while the governments may play a role in the choice of food of its citizens, it is still the responsibility of every individual whether to eat healthy diet or not due to many reasons being that a variety of methods to balance their diets or their finances. After all our life is in our hands!`,

            band7: `In many countries children are engaged in some kind of paid work. Some people regard this as completely wrong, while others consider it as valuable work experience, important for learning and taking responsibility. What are your opinions on this?

In today's world, the issue of children participating in paid work is a controversial topic. While some individuals think it's entirely inappropriate, others believe it offers important life lessons. I believe that whether children should work depends heavily on the type of work, the hours involved, and their age.

There are certainly negative aspects to children engaging in paid employment. Primarily, work can interfere with education, which should be the priority for young people. When children spend hours working, they may have less time and energy to devote to their studies, potentially affecting their academic performance and future prospects. Additionally, some forms of employment can be physically demanding or potentially dangerous for children whose bodies are still developing. In the worst cases, child labor might involve exploitation, with children receiving unfair wages or working in unsafe conditions.

However, there are also benefits to children gaining work experience in appropriate contexts. Light work for a few hours weekly can teach valuable skills like time management, financial literacy, and responsibility. For example, a teenager delivering newspapers before school can learn about commitment and managing their schedule. Moreover, early work experiences can help young people develop social skills and confidence in interacting with different people. This preparation can be valuable for their future careers, giving them a head start in understanding workplace dynamics.

I believe the key is finding the right balance. Ideally, any work done by children should be age-appropriate, safe, and regulated to ensure they are not exploited. It should also be limited in hours so that it doesn't interfere with education, rest, and leisure time. Different age groups require different considerations - what's appropriate for a 16-year-old is very different from what's suitable for a 10-year-old.

In conclusion, while children participating in appropriate, regulated work can gain valuable experience, their education and wellbeing must always take priority. The most important factor is ensuring that any work experience enhances rather than detracts from their development and future opportunities.`,

            band6: `Some people believe that technology has made our lives too complex and the solution is to lead a simpler life without technology. To what extent do you agree or disagree?

In this modern world, technology has become an integral part of our daily lives. Some people think that it has complicated our lives and we should return to a simpler lifestyle without technology. I believe this view is not entirely correct because technology has many benefits, although I agree that sometimes it can make things complex.

First, technology has made our lives easier in many ways. For example, with smartphones we can communicate with people anywhere instantly, which was impossible in the past. Also, technology helps us to do many tasks quickly like booking tickets online instead of going to travel agencies. In healthcare, modern equipment can diagnose diseases accurately and treat them effectively. These advancements have improved our quality of life significantly.

However, it is true that technology sometimes creates problems. Many people feel stressed because they are always connected to work through emails and messages. Additionally, social media can be addictive and reduce face-to-face interactions between people. Some elderly individuals find it difficult to use new technologies, which can isolate them from society. Also, there are concerns about privacy and security when using the internet.

I think rather than abandoning technology completely, we should learn to use it wisely. People can benefit from technology while minimizing its negative impacts. For instance, we can set specific times to check emails and messages instead of being available 24/7. We can also teach elderly people to use basic technology to help them stay connected with family and friends. Companies can design more user-friendly devices that are easier for everyone to use.

In conclusion, while technology does make life complicated sometimes, it offers more advantages than disadvantages. Therefore, I disagree with the idea that we should give up technology and return to a simpler life. Instead, we should focus on using technology in a balanced way that enhances our lives without causing unnecessary stress or complexity.`,

            band5: `In many countries around the world, the older people become, the respect they receive from others. However, this is not true in all cultures, and the situation is changing in many places. What are the advantages and disadvantages of this trend?

In modern world older people get less respect from society than before. This essay discusses advantages and disadvantages of this trend that is happening in many countries today.

One advantage of not respecting older people is that young people can do what they want. Young generation doesn't need to listen to old people's advice and can live their own life. It also means that old people don't have so much power in family and cannot control young people's decisions. For example, in my country before older people would decide about marriage of their children but now young people can choose themself.

Another advantage is that new ideas can be accepted more easily. Old people usually don't like changes and want to keep traditions. But without respect for them society can have more progress and develop faster without old people stopping new ideas.

However there are disadvantages too. First of all, old people have much experience and knowledge about life but young people don't listen to them so they repeat same mistakes. For example, grandparents know many useful things about raising children that could help young parents if they respect elders' advice.

Another disadvantage is that without respect, many old people feel sad and lonely. They worked all their life and now nobody cares about them. This can cause problems with depression among elderly people. Also it means that young people might not take care of their parents when they are old.

In conclusion, there are both advantages and disadvantages of this trend. I think that while young people should be independent, they should still respect older generation because they have valuable experience and deserve good treatment after working hard all their life.`
        };

        // Load benchmark sample
        function loadBenchmarkSample(band) {
            document.querySelectorAll('.benchmark-sample').forEach(sample => {
                sample.classList.remove('active');
            });
            document.querySelector(`.benchmark-sample[onclick="loadBenchmarkSample('${band}')"]`).classList.add('active');

            document.getElementById('benchmark-text').value = benchmarkSamples[band];

            // Display band score analysis
            const bandNumber = band.replace('band', '');
            const analysis = getBandAnalysis(bandNumber);
            document.getElementById('benchmark-analysis').innerHTML = analysis;
            document.getElementById('benchmark-analysis').style.display = 'block';
        }

        // Get band analysis for benchmark samples
        function getBandAnalysis(band) {
            const analyses = {
                '9': `<h3>Band 9 Analysis</h3>
                <p>This essay demonstrates:</p>
                <ul>
                    <li><strong>Task Response:</strong> Sophisticated and complete development of the topic with well-substantiated positions and relevant examples.</li>
                    <li><strong>Coherence and Cohesion:</strong> Masterful organization with seamless progression of ideas and skillful use of cohesive devices.</li>
                    <li><strong>Lexical Resource:</strong> Extensive, precise vocabulary with very natural and sophisticated control of lexical features.</li>
                    <li><strong>Grammar:</strong> Wide range of complex structures used with full flexibility and accuracy.</li>
                </ul>
                <p>Key strengths include the nuanced approach to the argument, sophisticated vocabulary (e.g., "prosocial behaviors," "experiential learning"), and varied sentence structures.</p>`,

                '8': `<h3>Band 8 Analysis</h3>
                <p>This essay demonstrates:</p>
                <ul>
                    <li><strong>Task Response:</strong> Addresses all parts of the task with a clear position throughout and well-developed ideas.</li>
                    <li><strong>Coherence and Cohesion:</strong> Logically organized with good use of paragraphing and cohesive devices.</li>
                    <li><strong>Lexical Resource:</strong> Wide vocabulary used fluently with good awareness of style and collocation.</li>
                    <li><strong>Grammar:</strong> Wide range of structures with good control and only occasional errors.</li>
                </ul>
                <p>The essay effectively presents multiple perspectives and uses appropriate examples. Vocabulary is sophisticated (e.g., "diametrically opposed," "omnivorous") and paragraphing is logical.</p>`,

                '7': `<h3>Band 7 Analysis</h3>
                <p>This essay demonstrates:</p>
                <ul>
                    <li><strong>Task Response:</strong> Addresses all parts of the task with a clear position and relevant main ideas.</li>
                    <li><strong>Coherence and Cohesion:</strong> Logically organized with clear progression throughout and appropriate use of cohesive devices.</li>
                    <li><strong>Lexical Resource:</strong> Sufficient range of vocabulary with some flexibility and accuracy.</li>
                    <li><strong>Grammar:</strong> Variety of complex structures with good control despite some errors.</li>
                </ul>
                <p>The essay has a clear structure and presents a balanced view with relevant examples. There are occasional minor errors but they don't impede communication.</p>`,

                // Get band analysis for benchmark samples (continued)
                '6': `<h3>Band 6 Analysis</h3>
                <p>This essay demonstrates:</p>
                <ul>
                    <li><strong>Task Response:</strong> Addresses the task but may be slightly unbalanced or have some irrelevant details.</li>
                    <li><strong>Coherence and Cohesion:</strong> Generally organized with some use of cohesive devices, though connections may be mechanical.</li>
                    <li><strong>Lexical Resource:</strong> Adequate vocabulary for the task with some awareness of style and collocation.</li>
                    <li><strong>Grammar:</strong> Mix of complex and simple structures with error patterns that may occasionally impede meaning.</li>
                </ul>
                <p>The essay presents the main ideas clearly but with less sophistication than higher band scores. There is appropriate use of linking words but some sentences lack complexity.</p>`,

                '5': `<h3>Band 5 Analysis</h3>
                <p>This essay demonstrates:</p>
                <ul>
                    <li><strong>Task Response:</strong> Addresses the task but with some underdevelopment or irrelevance.</li>
                    <li><strong>Coherence and Cohesion:</strong> Basic organization but with limited and repetitive linking devices.</li>
                    <li><strong>Lexical Resource:</strong> Limited range of vocabulary with noticeable errors in word choice and formation.</li>
                    <li><strong>Grammar:</strong> Limited range of structures with frequent errors that occasionally obscure meaning.</li>
                </ul>
                <p>The essay shows understanding of the topic but lacks precision in language use. There are noticeable grammar errors (e.g., "old people don't like changes") and some unclear expressions.</p>`
            };

            return analyses[band] || '';
        }

        // Main function to analyze essay
        async function analyzeEssay() {
            const essayText = document.getElementById('essay-input').value.trim();
            const taskType = document.querySelector('input[name="task"]:checked').value;
            const analysisMode = document.querySelector('input[name="mode"]:checked').value;

            if (!essayText) {
                alert('Please enter your essay text.');
                return;
            }

            // Show loader
            document.getElementById('analysis-loader').style.display = 'inline-block';
            document.getElementById('analyze-button').disabled = true;
            document.getElementById('analyze-button').classList.add('button-disabled');

            try {
                // Basic analysis (always performed)
                const basicAnalysis = performBasicAnalysis(essayText, taskType);

                // For advanced analysis with AI
                let aiAnalysis = null;
                if (analysisMode === 'advanced') {
                    const apiKey = localStorage.getItem('geminiApiKey');
                    if (!apiKey) {
                        alert('Please enter your API key in the Settings tab.');
                        document.getElementById('analysis-loader').style.display = 'none';
                        document.getElementById('analyze-button').disabled = false;
                        document.getElementById('analyze-button').classList.remove('button-disabled');
                        return;
                    }

                    // Perform AI analysis
                    try {
                        aiAnalysis = await performAIAnalysis(essayText, taskType, apiKey);
                    } catch (error) {
                        console.error('AI Analysis error:', error);
                        alert('Error with AI analysis. Please check your API key and try again.');
                        document.getElementById('analysis-loader').style.display = 'none';
                        document.getElementById('analyze-button').disabled = false;
                        document.getElementById('analyze-button').classList.remove('button-disabled');
                        return;
                    }
                }

                // Combine analyses and display results
                displayResults(basicAnalysis, aiAnalysis);

                // Show results container
                document.getElementById('result-container').style.display = 'block';

                // Scroll to results
                document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Analysis error:', error);
                alert('An error occurred during analysis. Please try again.');
            } finally {
                // Hide loader
                document.getElementById('analysis-loader').style.display = 'none';
                document.getElementById('analyze-button').disabled = false;
                document.getElementById('analyze-button').classList.remove('button-disabled');
            }
        }

        // Basic analysis function
        function performBasicAnalysis(text, taskType) {
            // Word count
            const words = text.split(/\s+/);
            const wordCount = words.length;

            // Sentence count and average length
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentenceCount = sentences.length;
            const avgSentenceLength = wordCount / sentenceCount;

            // Paragraph count
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            const paragraphCount = paragraphs.length;

            // Check for minimum word count
            const minWords = taskType === 'task1' ? 150 : 250;
            const meetsMinWordCount = wordCount >= minWords;

            // Common grammar and spelling errors (simplified)
            const grammarErrors = findGrammarErrors(text);
            const spellingErrors = findSpellingErrors(text);

            // Estimate cohesion by checking for linking words
            const cohesionScore = analyzeCohesion(text);

            // Analyze vocabulary diversity
            const vocabScore = analyzeVocabulary(text);

            // Analyze grammar
            const grammarScore = analyzeGrammar(text, grammarErrors);

            // Calculate task achievement score
            const taskScore = calculateTaskScore(text, taskType, wordCount, minWords, paragraphCount);

            // Calculate overall score
            const overallScore = ((taskScore + cohesionScore + vocabScore + grammarScore) / 4).toFixed(1);

            return {
                wordCount,
                sentenceCount,
                avgSentenceLength,
                paragraphCount,
                meetsMinWordCount,
                grammarErrors,
                spellingErrors,
                scores: {
                    task: taskScore.toFixed(1),
                    coherence: cohesionScore.toFixed(1),
                    lexical: vocabScore.toFixed(1),
                    grammar: grammarScore.toFixed(1),
                    overall: overallScore
                },
                feedback: generateBasicFeedback(taskScore, cohesionScore, vocabScore, grammarScore, wordCount, minWords, paragraphCount)
            };
        }

        // AI Analysis with Gemini API
        async function performAIAnalysis(text, taskType, apiKey) {
            const taskTypeName = taskType === 'task1' ? 'Task 1 (Graph/Chart Description)' : 'Task 2 (Essay)';

            const prompt = `
            You are an expert IELTS examiner. Please evaluate the following ${taskTypeName} essay according to the official IELTS marking criteria:

            1. Task Achievement/Response (for Task 1/2): How well the essay addresses all parts of the task with relevant, fully extended ideas
            2. Coherence and Cohesion: How well the essay is organized, with clear progression and appropriate use of cohesive devices
            3. Lexical Resource: Range, accuracy and appropriateness of vocabulary
            4. Grammatical Range and Accuracy: Range and accurate use of grammar

            For each criterion, please:
            1. Provide a band score (0-9, with decimal points like 6.5 allowed)
            2. Give specific evidence from the text to justify the score
            3. Provide actionable feedback for improvement

            Then give an overall band score (average of the four scores, rounded to the nearest 0.5).

            Finally, provide detailed corrections for up to 10 specific errors or areas of improvement in the essay, focusing on the most significant issues.

            Essay to evaluate:
            "${text}"

            Format your response in JSON with the following structure:
            {
              "scores": {
                "task": 0.0,
                "coherence": 0.0,
                "lexical": 0.0,
                "grammar": 0.0,
                "overall": 0.0
              },
              "feedback": {
                "task": "Detailed feedback...",
                "coherence": "Detailed feedback...",
                "lexical": "Detailed feedback...",
                "grammar": "Detailed feedback..."
              },
              "overallFeedback": "Summary of strengths and weaknesses with advice for improvement...",
              "corrections": [
                {
                  "type": "grammar/vocabulary/coherence",
                  "error": "The actual text with error",
                  "correction": "Suggested correction",
                  "explanation": "Why this is an error and explanation of the correction"
                }
              ]
            }
            `;

            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent";

            const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.2,
                        maxOutputTokens: 8192
                    }
                })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error.message || "API Error");
            }

            try {
                const resultText = data.candidates[0].content.parts[0].text;
                // Extract JSON from the response
                const jsonMatch = resultText.match(/```json\n([\s\S]*?)\n```/) || resultText.match(/({[\s\S]*})/);
                const jsonString = jsonMatch ? jsonMatch[1] : resultText;

                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Error parsing AI response:", error);
                console.log("Raw response:", data);
                throw new Error("Could not parse AI response");
            }
        }

        // Display results
        function displayResults(basicAnalysis, aiAnalysis) {
            // Use AI analysis if available, otherwise use basic analysis
            const analysis = aiAnalysis || basicAnalysis;

            // Update scores
            document.getElementById('task-score').textContent = analysis.scores.task;
            document.getElementById('coherence-score').textContent = analysis.scores.coherence;
            document.getElementById('lexical-score').textContent = analysis.scores.lexical;
            document.getElementById('grammar-score').textContent = analysis.scores.grammar;
            document.getElementById('overall-score').textContent = analysis.scores.overall;

            // Update feedback
            if (aiAnalysis) {
                document.getElementById('overall-feedback').innerHTML = aiAnalysis.overallFeedback;

                // Show AI feedback container
                document.getElementById('ai-feedback-container').style.display = 'block';

                // Format detailed feedback
                let detailedFeedback = `
                    <h4>Task Achievement/Response: ${aiAnalysis.scores.task}</h4>
                    <p>${aiAnalysis.feedback.task}</p>
                    
                    <h4>Coherence and Cohesion: ${aiAnalysis.scores.coherence}</h4>
                    <p>${aiAnalysis.feedback.coherence}</p>
                    
                    <h4>Lexical Resource: ${aiAnalysis.scores.lexical}</h4>
                    <p>${aiAnalysis.feedback.lexical}</p>
                    
                    <h4>Grammatical Range and Accuracy: ${aiAnalysis.scores.grammar}</h4>
                    <p>${aiAnalysis.feedback.grammar}</p>
                `;

                document.getElementById('ai-feedback').innerHTML = detailedFeedback;

                // Display corrections
                displayCorrections(aiAnalysis.corrections);
            } else {
                document.getElementById('overall-feedback').innerHTML = basicAnalysis.feedback;
                document.getElementById('ai-feedback-container').style.display = 'none';

                // Display basic corrections
                const basicCorrections = [
                    ...basicAnalysis.grammarErrors.map(error => ({
                        type: 'grammar',
                        error: error.text,
                        correction: error.suggestion,
                        explanation: error.explanation
                    })),
                    ...basicAnalysis.spellingErrors.map(error => ({
                        type: 'vocabulary',
                        error: error.text,
                        correction: error.suggestion,
                        explanation: "Spelling error"
                    }))
                ];

                displayCorrections(basicCorrections);
            }

            // Display highlighted text
            displayHighlightedText(document.getElementById('essay-input').value, analysis);
        }

        // Display corrections
        function displayCorrections(corrections) {
            const container = document.getElementById('corrections-container');
            container.innerHTML = '';

            if (!corrections || corrections.length === 0) {
                container.innerHTML = '<p>No significant errors detected.</p>';
                return;
            }

            corrections.forEach(correction => {
                const element = document.createElement('div');
                element.className = correction.type === 'grammar' ? 'error' :
                    correction.type === 'vocabulary' ? 'error' : 'correction';

                element.innerHTML = `
                    <strong>${correction.type.charAt(0).toUpperCase() + correction.type.slice(1)} Issue:</strong>
                    <p><em>"${correction.error}"</em> → <strong>"${correction.correction}"</strong></p>
                    <p>${correction.explanation}</p>
                `;

                container.appendChild(element);
            });
        }

        // Display highlighted text
        function displayHighlightedText(text, analysis) {
            const container = document.getElementById('highlighted-text');

            // If AI analysis is available, use its corrections
            if (analysis.corrections) {
                let highlightedText = text;

                // Create a copy of the array to avoid sorting the original
                const sortedCorrections = [...analysis.corrections].sort((a, b) => {
                    // Sort by position of error in the text (earliest first)
                    return text.indexOf(a.error) - text.indexOf(b.error);
                });

                // Replace each error with a highlighted version
                sortedCorrections.forEach(correction => {
                    const highlightClass = correction.type === 'grammar' ? 'grammar-error' :
                        correction.type === 'vocabulary' ? 'vocabulary-error' : 'coherence-error';

                    highlightedText = highlightedText.replace(
                        correction.error,
                        `<span class="${highlightClass}" title="${correction.explanation}">${correction.error}</span>`
                    );
                });

                // Replace newlines with <br> for HTML display
                highlightedText = highlightedText.replace(/\n/g, '<br>');
                container.innerHTML = highlightedText;
            } else {
                // Basic highlighting for grammar and spelling errors
                let highlightedText = text;

                // Highlight grammar errors
                analysis.grammarErrors.forEach(error => {
                    highlightedText = highlightedText.replace(
                        error.text,
                        `<span class="grammar-error" title="${error.explanation}">${error.text}</span>`
                    );
                });

                // Highlight spelling errors
                analysis.spellingErrors.forEach(error => {
                    highlightedText = highlightedText.replace(
                        error.text,
                        `<span class="vocabulary-error" title="Spelling error">${error.text}</span>`
                    );
                });

                // Replace newlines with <br> for HTML display
                highlightedText = highlightedText.replace(/\n/g, '<br>');
                container.innerHTML = highlightedText;
            }
        }

        // Helper functions for basic analysis
        function findGrammarErrors(text) {
            // This is a simplified version - in a real app, you'd use a grammar checking API
            const commonErrors = [
                { pattern: /\b(is|are|was|were) ([\w]+)ing\b/g, suggestion: "$1 $2ed", explanation: "Incorrect continuous tense" },
                { pattern: /\b(have|has) went\b/g, suggestion: "$1 gone", explanation: "Incorrect past participle" },
                { pattern: /\bi am agree\b/gi, suggestion: "I agree", explanation: "Incorrect verb form" },
                { pattern: /\bthey is\b/gi, suggestion: "they are", explanation: "Subject-verb agreement error" },
                { pattern: /\bhe have\b/gi, suggestion: "he has", explanation: "Subject-verb agreement error" },
                { pattern: /\bshe have\b/gi, suggestion: "she has", explanation: "Subject-verb agreement error" },
                { pattern: /\bit have\b/gi, suggestion: "it has", explanation: "Subject-verb agreement error" },
                { pattern: /\bin the other hand\b/gi, suggestion: "on the other hand", explanation: "Incorrect preposition" },
                { pattern: /\bdepend of\b/gi, suggestion: "depend on", explanation: "Incorrect preposition" },
                { pattern: /\bin my opinion I think\b/gi, suggestion: "in my opinion", explanation: "Redundant expression" }
            ];

            const errors = [];

            commonErrors.forEach(error => {
                const matches = text.matchAll(error.pattern);
                for (const match of matches) {
                    errors.push({
                        text: match[0],
                        suggestion: match[0].replace(error.pattern, error.suggestion),
                        explanation: error.explanation
                    });
                }
            });

            return errors;
        }

        function findSpellingErrors(text) {
            // This is a simplified version - in a real app, you'd use a spelling API
            const commonMisspellings = {
                'accomodate': 'accommodate',
                'acheive': 'achieve',
                'accross': 'across',
                'agressive': 'aggressive',
                'beggining': 'beginning',
                'beleive': 'believe',
                'concious': 'conscious',
                'definately': 'definitely',
                'developement': 'development',
                'enviroment': 'environment',
                'goverment': 'government',
                'independant': 'independent',
                'occured': 'occurred',
                'posession': 'possession',
                'recieve': 'receive',
                'sucessful': 'successful',
                'untill': 'until'
            };

            const errors = [];
            const words = text.split(/\s+/);

            words.forEach(word => {
                const cleanWord = word.toLowerCase().replace(/[.,?!;:()]/g, '');
                if (commonMisspellings[cleanWord]) {
                    errors.push({
                        text: word,
                        suggestion: word.replace(cleanWord, commonMisspellings[cleanWord]),
                        explanation: "Spelling error"
                    });
                }
            });

            return errors;
        }

        function analyzeCohesion(text) {
            // Check for cohesive devices
            const cohesiveDevices = [
                'however', 'therefore', 'furthermore', 'moreover', 'nevertheless',
                'consequently', 'firstly', 'secondly', 'finally', 'in addition',
                'on the other hand', 'in contrast', 'similarly', 'for example',
                'in conclusion', 'to summarize', 'as a result', 'despite this',
                'although', 'even though', 'yet', 'besides', 'additionally',
                'likewise', 'whereas', 'nonetheless', 'meanwhile', 'alternatively'
            ];

            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);

            // Check if text has introduction and conclusion
            const hasIntro = paragraphs.length > 0;
            const hasConclusion = paragraphs.length > 1 &&
                (paragraphs[paragraphs.length - 1].toLowerCase().includes('conclusion') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('in summary') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('to summarize') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('overall'));

            // Count cohesive devices used
            let cohesiveDeviceCount = 0;
            cohesiveDevices.forEach(device => {
                const regex = new RegExp('\\b' + device + '\\b', 'gi');
                const matches = text.match(regex);
                if (matches) {
                    cohesiveDeviceCount += matches.length;
                }
            });

            // Calculate diversity of cohesive devices
            const uniqueDevices = new Set();
            cohesiveDevices.forEach(device => {
                const regex = new RegExp('\\b' + device + '\\b', 'gi');
                if (regex.test(text)) {
                    uniqueDevices.add(device);
                }
            });

            // Calculate cohesion score based on these factors
            let score = 5.0; // Starting point

            // Credit for paragraphing
            if (paragraphs.length >= 4) score += 0.5;
            if (hasIntro) score += 0.5;
            if (hasConclusion) score += 0.5;

            // Credit for cohesive devices
            if (cohesiveDeviceCount >= 3) score += 0.5;
            if (cohesiveDeviceCount >= 6) score += 0.5;
            if (uniqueDevices.size >= 3) score += 0.5;
            if (uniqueDevices.size >= 5) score += 0.5;

            // Cap at 9.0
            return Math.min(score, 9.0);
        }

        function analyzeVocabulary(text) {
            const words = text.toLowerCase().match(/\b\w+\b/g) || [];
            const wordSet = new Set(words);

            // Calculate lexical diversity (unique words / total words)
            const lexicalDiversity = wordSet.size / words.length;

            // Check for advanced vocabulary
            const advancedVocab = [
                'substantial', 'significant', 'consequently', 'nevertheless', 'furthermore',
                'undoubtedly', 'arguably', 'ultimately', 'fundamental', 'considerable',
                'demonstrate', 'perspective', 'controversial', 'approximately', 'beneficial',
                'detrimental', 'essential', 'phenomenon', 'predominantly', 'sustainable',
                'crucial', 'innovative', 'widespread', 'implications', 'implemented'
            ];

            let advancedWordCount = 0;
            advancedVocab.forEach(word => {
                const regex = new RegExp('\\b' + word + '\\b', 'gi');
                const matches = text.match(regex);
                if (matches) {
                    advancedWordCount += matches.length;
                }
            });

            // Calculate vocabulary score
            let score = 5.0; // Starting point

            // Credit for lexical diversity
            if (lexicalDiversity > 0.4) score += 0.5;
            if (lexicalDiversity > 0.5) score += 0.5;
            if (lexicalDiversity > 0.6) score += 0.5;

            // Credit for advanced vocabulary
            if (advancedWordCount >= 2) score += 0.5;
            if (advancedWordCount >= 5) score += 0.5;
            if (advancedWordCount >= 8) score += 1.0;

            // Penalty for spelling errors
            const spellingErrors = findSpellingErrors(text).length;
            if (spellingErrors >= 5) score -= 0.5;
            if (spellingErrors >= 10) score -= 0.5;

            // Cap at 9.0
            return Math.min(Math.max(score, 4.0), 9.0);
        }

        function analyzeGrammar(text, grammarErrors) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);

            // Check for complex sentence structures
            let complexSentences = 0;
            const complexMarkers = [
                'although', 'despite', 'even though', 'whereas', 'while', 'nevertheless',
                'however', 'therefore', 'consequently', 'because', 'since', 'as',
                'unless', 'until', 'provided that', 'assuming that', 'given that'
            ];

            sentences.forEach(sentence => {
                complexMarkers.forEach(marker => {
                    if (sentence.toLowerCase().includes(marker)) {
                        complexSentences++;
                        return;
                    }
                });
            });

            // Calculate percentage of complex sentences
            const complexSentenceRatio = complexSentences / sentences.length;

            // Calculate average sentence length
            const words = text.split(/\s+/);
            const avgSentenceLength = words.length / sentences.length;

            // Calculate grammar score
            let score = 5.0; // Starting point

            // Credit for complex sentences
            if (complexSentenceRatio > 0.3) score += 0.5;
            if (complexSentenceRatio > 0.5) score += 0.5;

            // Credit for sentence variety
            if (avgSentenceLength > 12 && avgSentenceLength < 25) score += 0.5;

            // Penalty for grammar errors
            if (grammarErrors.length >= 3) score -= 0.5;
            if (grammarErrors.length >= 6) score -= 0.5;
            if (grammarErrors.length >= 10) score -= 0.5;

            // Cap at 9.0
            return Math.min(Math.max(score, 4.0), 9.0);
        }

        function calculateTaskScore(text, taskType, wordCount, minWords, paragraphCount) {
            let score = 5.0; // Starting point

            // Check if meets minimum word count
            if (wordCount < minWords) {
                score -= 1.0; // Significant penalty for being under word count
            }

            // Check for proper paragraphing
            if (taskType === 'task1') {
                // For Task 1, we expect 3-4 paragraphs
                if (paragraphCount >= 3) score += 0.5;
            } else {
                // For Task 2, we expect 4-5 paragraphs
                if (paragraphCount >= 4) score += 0.5;
            }

            // Check for introduction and conclusion
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            const hasIntro = paragraphs.length > 0;
            const hasConclusion = paragraphs.length > 1 &&
                (paragraphs[paragraphs.length - 1].toLowerCase().includes('conclusion') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('in summary') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('to summarize') ||
                    paragraphs[paragraphs.length - 1].toLowerCase().includes('overall'));

            if (hasIntro) score += 0.5;
            if (hasConclusion) score += 0.5;

            // For Task 2, check if position is stated clearly
            if (taskType === 'task2') {
                const hasPosition = /\b(I believe|In my opinion|I think|I agree|I disagree)\b/i.test(text);
                if (hasPosition) score += 0.5;
            }

            // For Task 1, check for proper data description language
            if (taskType === 'task1') {
                const hasDataLanguage = /\b(increased|decreased|rose|fell|remained stable|fluctuated|trend|figure|percentage|proportion)\b/i.test(text);
                if (hasDataLanguage) score += 0.5;
            }

            // Cap at 9.0
            return Math.min(Math.max(score, 4.0), 9.0);
        }

        function generateBasicFeedback(taskScore, cohesionScore, vocabScore, grammarScore, wordCount, minWords, paragraphCount) {
            let feedback = "";

            // Overall assessment
            const overallScore = ((taskScore + cohesionScore + vocabScore + grammarScore) / 4);

            if (overallScore >= 7.0) {
                feedback += "<p>This is a strong response that demonstrates good command of English. ";
            } else if (overallScore >= 6.0) {
                feedback += "<p>This is a competent response with some areas for improvement. ";
            } else {
                feedback += "<p>This response shows basic English skills but needs significant improvement. ";
            }

            // Word count feedback
            if (wordCount < minWords) {
                feedback += `Your essay is ${wordCount} words, which is below the minimum requirement of ${minWords} words. This will lower your score. `;
            }

            // Paragraph structure feedback
            if (paragraphCount < 3) {
                feedback += "Your essay needs better paragraphing. Try to include an introduction, body paragraphs, and a conclusion. ";
            }

            // Task Achievement feedback
            if (taskScore < 6.0) {
                feedback += "Your task achievement could be improved by more fully addressing all parts of the prompt and developing your ideas with examples. ";
            }

            // Coherence feedback
            if (cohesionScore < 6.0) {
                feedback += "Try to improve essay organization and use more cohesive devices to connect your ideas. ";
            }

            // Vocabulary feedback
            if (vocabScore < 6.0) {
                feedback += "Work on expanding your vocabulary range and avoiding repetition. ";
            }

            // Grammar feedback
            if (grammarScore < 6.0) {
                feedback += "Focus on improving grammatical accuracy and using a variety of sentence structures. ";
            }

            feedback += "</p>";

            // Add specific recommendations
            feedback += "<p><strong>Recommendations:</strong></p><ul>";

            if (taskScore < overallScore) {
                feedback += "<li>Make sure to fully address all parts of the question and support your ideas with specific examples.</li>";
            }

            if (cohesionScore < overallScore) {
                feedback += "<li>Improve your paragraph organization and use more varied linking words (however, therefore, furthermore, etc.).</li>";
            }

            if (vocabScore < overallScore) {
                feedback += "<li>Use more precise vocabulary and academic expressions to demonstrate lexical range.</li>";
            }

            if (grammarScore < overallScore) {
                feedback += "<li>Practice using complex sentence structures and check your work for grammatical errors.</li>";
            }

            feedback += "</ul>";

            return feedback;
        }
    </script>
</body>

</html>
